#!/bin/sh
# Auto-installing pre-commit hook for Go projects.
# Skips: set SKIP_PRE_COMMIT=1 or CI=1 to bypass the hook
# Partial skips: SKIP_LINT=1, SKIP_TESTS=1

set -e

# -----------------------
# Colors
# -----------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # no color

warnings=()

# -----------------------
# Skip hook entirely
# -----------------------
if [ -n "$SKIP_PRE_COMMIT" ] || [ -n "$CI" ]; then
    echo -e "${YELLOW}[pre-commit] skipping (SKIP_PRE_COMMIT or CI set)${NC}"
    exit 0
fi

root="$(git rev-parse --show-toplevel)"

# -----------------------
# Tests (first!)
# -----------------------
if [ -z "$SKIP_TESTS" ]; then
    echo -e "${GREEN}[pre-commit] running tests${NC}"
    cd "$(dirname "$0")/.." || exit 1
    if go test -v ./...; then
        echo -e "${GREEN}✔ Tests passed${NC}"
    else
        echo -e "${RED}✖ Tests failed. Fix them before committing.${NC}"
        exit 1
    fi
fi

# -----------------------
# Helper: install Go tool if missing
# -----------------------
install_go_tool() {
    name="$1"
    pkg="$2"

    if command -v "$name" >/dev/null 2>&1; then
        return 0
    fi

    echo -e "${YELLOW}[pre-commit] $name missing → installing ($pkg)${NC}"

    if ! go install "$pkg"; then
        echo -e "${RED}ERROR: failed to install $name ($pkg). Aborting commit.${NC}"
        exit 1
    fi

    # Add GOPATH/bin to PATH for the current shell
    export PATH="$(go env GOPATH)/bin:$PATH"

    if ! command -v "$name" >/dev/null 2>&1; then
        echo -e "${RED}ERROR: $name still not found after installation. Check PATH.${NC}"
        exit 1
    fi
}

# -----------------------
# Install missing tools
# -----------------------
install_go_tool gofumpt mvdan.cc/gofumpt@latest
install_go_tool goimports golang.org/x/tools/cmd/goimports@latest
install_go_tool staticcheck honnef.co/go/tools/cmd/staticcheck@latest

if [ -z "$SKIP_LINT" ] && ! command -v golangci-lint >/dev/null 2>&1; then
    echo -e "${YELLOW}[pre-commit] golangci-lint missing → installing${NC}"
    curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
        | sh -s -- -b "$(go env GOPATH)/bin" latest

    # Add GOPATH/bin to PATH for golangci-lint as well
    export PATH="$(go env GOPATH)/bin:$PATH"

    if ! command -v golangci-lint >/dev/null 2>&1; then
        echo -e "${RED}ERROR: failed to install golangci-lint. Aborting commit.${NC}"
        exit 1
    fi
fi

# -----------------------
# Lint
# -----------------------
if [ -z "$SKIP_LINT" ]; then
    echo -e "${GREEN}[pre-commit] running golangci-lint${NC}"
    golangci-lint run ./...
fi

# -----------------------
# Static analysis
# -----------------------
echo -e "${GREEN}[pre-commit] running staticcheck${NC}"
staticcheck ./...

echo -e "${GREEN}[pre-commit] running go vet${NC}"
go vet ./...

# -----------------------
# Formatting (warning only)
# -----------------------
echo -e "${GREEN}[pre-commit] formatting: gofumpt -> goimports${NC}"
gofumpt -w .
goimports -w .

if ! git diff --quiet --; then
    warnings+=("${YELLOW}⚠ Formatting changed files:${NC}")
    warnings+=("$(git --no-pager diff --name-only)")
fi

# -----------------------
# Module tidy (warning only)
# -----------------------
echo -e "${GREEN}[pre-commit] running go mod tidy${NC}"
go mod tidy

if ! git diff --quiet -- go.mod go.sum; then
    warnings+=("${YELLOW}⚠ go.mod or go.sum modified:${NC}")
    warnings+=("$(git --no-pager diff --name-only -- go.mod go.sum)")
fi

# -----------------------
# Print warnings at the end
# -----------------------
if [ ${#warnings[@]} -ne 0 ]; then
    for w in "${warnings[@]}"; do
        echo -e "$w"
    done
    echo -e "${YELLOW}Please git add the changes before pushing.${NC}"
fi

# -----------------------
# Success message
# -----------------------
echo -e "${GREEN}✔ All checks passed${NC}"
exit 0
